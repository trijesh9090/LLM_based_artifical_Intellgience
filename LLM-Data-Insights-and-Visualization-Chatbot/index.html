<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Data Chatbot</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        canvas { display: block; width: 100% !important; height: 100% !important; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        Chart.register(
            Chart.LineController, Chart.BarController,
            Chart.PointElement, Chart.LineElement, Chart.BarElement, Chart.ArcElement,
            Chart.Tooltip, Chart.Legend, Chart.Title,
            Chart.LinearScale, Chart.CategoryScale, Chart.TimeScale, Chart.LogarithmicScale, Chart.RadialLinearScale
        );

        const App = () => {
            const [csvData, setCsvData] = useState([]);
            const [csvPreview, setCsvPreview] = useState([]);
            const [insights, setInsights] = useState('');
            const [rawResponse, setRawResponse] = useState(null);
            const [chartJsConfigs, setChartJsConfigs] = useState([]);
            const [loading, setLoading] = useState(false);
            const [prompt, setPrompt] = useState('');
            const [showJson, setShowJson] = useState(false);
            const chartContainerRef = useRef(null);
            const chartInstancesRef = useRef([]);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        setCsvData(results.data);
                        setCsvPreview(results.data.slice(0,5));
                        setInsights('');
                        setRawResponse(null);
                        setChartJsConfigs([]);
                    },
                    error: () => setInsights('Error parsing CSV.')
                });
            };

            const generateVisualizationAndInsights = async () => {
                if (!csvData.length) {
                    setInsights('Please upload a CSV file first.'); return;
                }
                if (!prompt.trim()) {
                    setInsights('Please enter a request.'); return;
                }
                setLoading(true);

                const sample = csvData.slice(0, 10);
                const headers = Object.keys(csvData[0] || {});
                const llmPrompt = `You are an expert data analyst and visualization specialist. The user has provided CSV data and a specific request. Your task is to: 1. Provide concise textual insights based on the user's prompt and the provided data. 2. Generate an ARRAY of complete Chart.js configuration objects to create visualizations based on the user's prompt. Each object in the array should represent a single chart and contain 'type' (string), 'data' (JSON string of the chart data object), and 'options' (JSON string of the chart options object). Data and options strings must be valid JSON objects without extra whitespace or concatenation. Here are the column headers: ${JSON.stringify(headers)}. Sample data (first ${sample.length} rows): ${JSON.stringify(sample)}. Full data: ${JSON.stringify(csvData)}. User's request: "${prompt}". Respond with a JSON object: { "insights": string, "chartJsCode": [ {"type":string, "data":string, "options":string}, ... ] } only.`;

                const payload = {
                    contents: [{ role: 'user', parts: [{ text: llmPrompt }] }],
                    generationConfig: {
                        responseMimeType: 'application/json',
                        responseSchema: {
                            type: 'OBJECT',
                            properties: {
                                insights: { type: 'STRING' },
                                chartJsCode: {
                                    type: 'ARRAY',
                                    items: { type: 'OBJECT', properties: {
                                        type: { type: 'STRING' },
                                        data: { type: 'STRING' },
                                        options: { type: 'STRING' }
                                    }, required: ['type','data','options'] }
                                }
                            },
                            propertyOrdering: ['insights','chartJsCode']
                        }
                    }
                };

                <!--add API key here-->
                const apiKey = '';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                try {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const json = await res.json();
                    const text = json.candidates[0].content.parts[0].text;
                    setRawResponse(text);
                    const parsed = JSON.parse(text);
                    setInsights(parsed.insights || 'No insights');
                    const configs = parsed.chartJsCode.map(c => ({
                        type: c.type,
                        data: JSON.parse(c.data),
                        options: JSON.parse(c.options)
                    }));
                    setChartJsConfigs(configs);
                } catch (e) {
                    console.error(e);
                    setInsights('Error fetching or parsing LLM response.');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                chartInstancesRef.current.forEach(c => c.destroy());
                chartInstancesRef.current = [];
                if (chartContainerRef.current) chartContainerRef.current.innerHTML = '';
                chartJsConfigs.forEach((cfg, i) => {
                    const canvas = document.createElement('canvas');
                    canvas.className = 'w-full h-96 mb-6';
                    chartContainerRef.current.appendChild(canvas);
                    try {
                        const chart = new Chart(canvas.getContext('2d'), cfg);
                        chartInstancesRef.current.push(chart);
                    } catch (err) {
                        console.error(`Chart ${i} error:`, err);
                    }
                });
            }, [chartJsConfigs]);

            return (
                <div className="min-h-screen p-4 bg-gray-100 flex flex-col items-center">
                    <h1 className="text-4xl font-bold text-blue-700 mb-8 text-center">LLM Data Insights & Visualization Chatbot</h1>
                    <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl mb-8">
                        <div className="mb-6">
                            <label className="block text-lg font-semibold mb-2">1. Upload CSV File:</label>
                            <input type="file" accept=".csv" onChange={handleFileUpload} className="block w-full border rounded p-2" />
                            {csvData.length > 0 && <p className="text-sm text-green-600 mt-2">Rows loaded: {csvData.length}</p>}
                            {csvPreview.length > 0 && (
                                <div className="mt-4 overflow-x-auto border rounded">
                                    <table className="min-w-full divide-y">
                                        <thead className="bg-gray-100"><tr>{Object.keys(csvPreview[0]).map((h,i)=>(<th key={i} className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">{h}</th>))}</tr></thead>
                                        <tbody>{csvPreview.map((row,ri)=>(<tr key={ri} className="bg-white divide-y">{Object.values(row).map((val,ci)=>(<td key={ci} className="px-4 py-2 text-sm text-gray-800 whitespace-nowrap">{val}</td>))}</tr>))}</tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                        <div className="mb-6">
                            <label className="block text-lg font-semibold mb-2">2. Enter Your Request:</label>
                            <textarea rows={4} value={prompt} onChange={e=>setPrompt(e.target.value)} className="w-full border rounded p-2" placeholder="e.g., 'Show me a bar chart of sales by region...'" />
                        </div>
                        <button onClick={generateVisualizationAndInsights} disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded text-xl hover:bg-blue-700">
                            {loading ? 'Generating...' : 'Generate Insights & Visualization'}
                        </button>
                    </div>
                    {insights && (
                        <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-4xl mb-8 relative">
                            <h2 className="text-2xl font-bold mb-2 flex items-center">Insights<button onClick={()=>setShowJson(true)} className="ml-2 text-gray-500 hover:text-gray-700" title="View raw JSON">?</button></h2>
                            <pre className="whitespace-pre-wrap text-gray-800">{insights}</pre>
                        </div>
                    )}
                    <div ref={chartContainerRef} className="w-full max-w-4xl mb-8"></div>
                    {showJson && rawResponse && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                            <div className="bg-white p-6 rounded-lg shadow-lg w-11/12 max-w-2xl">
                                <h3 className="text-xl font-semibold mb-4">Raw LLM JSON Response</h3>
                                <pre className="whitespace-pre-wrap text-sm overflow-auto max-h-96 bg-gray-100 p-4 rounded">{rawResponse}</pre>
                                <button onClick={()=>setShowJson(false)} className="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Close</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
